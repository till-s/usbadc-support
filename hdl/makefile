# Makefile automatically generated by ghdl
# Version: GHDL 1.0.0 (1.0.0.r0.g2fb2384d) [Dunoon edition] - GCC back-end code generator
# Command used to generate this makefile:
# ghdl --gen-makefile CommandWrapperTb

GHDL=ghdl
#GHDLFLAGS=-P
#GHDLFLAGS=-P -fsynopsys -Wl,-no-pie -g
GHDLFLAGS=-P/usr/lib/ghdl

# BRAM or SDRAM
SAMPLEBUFFER_TYPE=BRAM

# where to find RamEmul.vhd (if SAMPLEBUFFER_TYPE == SDRAM)
VPATH=../../SDRAM-Controller

HEREDIR:=$(dir $(lastword $(MAKEFILE_LIST)))

# Default target
TESTS= CommandWrapperTb CommandWrapperSim CicFilterTb PipelinedRShifterTb
TESTS+=SpiRegTb SpiShadowRegTb SampleBufferBRAMTb $(RAM_TEST_$(SAMPLEBUFFER_TYPE))
TESTS+=SimpleBusAsyncTb SimpleBusPipeStageTb

all: $(TESTS)

test: $(filter-out CommandWrapperSim,$(TESTS))
	for i in $^; do echo "Running $$i"; if ! ./$$i; then exit 1; fi done

RAM_EMUL_SDRAM=RamEmul
RAM_TEST_SDRAM=SampleBufferSDRAMTb

OBJS+=CommandMuxPkg.o ByteStuffer.o SFifo.o ByteDeStuffer.o
OBJS+=CommandMux.o SynchronizerBit.o BitBangIF.o CommandBitBang.o
OBJS+=MaxAdc.o CommandWrapper.o ILAWrapper.o ILAWrapperPkg.o AcqCtlPkg.o
OBJS+=CicFilter.o CommandAcqParm.o BasicPkg.o PipelinedRShifter.o
OBJS+=MulShifter.o SpiReg.o
OBJS+=CommandVersion.o
OBJS+=CommandSpi.o SpiBitShifter.o
OBJS+=SpiFlashSim.o SpiChecker.o
OBJS+=Flicker.o
OBJS+=CommandReg.o
OBJS+=SampleBufferBRAM.o
OBJS+=SampleBufferSDRAM.o
OBJS+=SampleBufferTbNotbound.o
OBJS+=SDRAMPkg.o
OBJS+=GenericFifoAsync.o
OBJS+=SimpleBusAsync.o
#OBJS+=SinCosGen.o
OBJS+=SimpleBusPipeStage.o
OBJS+=SpiShadowReg.o
OBJS+=$(addsuffix .o,$(RAM_EMUL_$(SAMPLEBUFFER_TYPE)))

# Elaboration target
CommandWrapperTb: CommandWrapperTb.o $(OBJS)
	$(GHDL) -e $(GHDLFLAGS) -o $@ $@

%Tb: %Tb.o $(OBJS)
	$(GHDL) -e $(GHDLFLAGS) -o $@ $@

CommandWrapperSim: $(OBJS) SimPty.o SimPtyIO.o CommandWrapperSim.o $(OBJS)
	$(GHDL) -e $(GHDLFLAGS) -Wl,SimPtyIO.o -o $@  $@

SampleBufferBRAMTb: SampleBufferBRAMTb.o
	$(GHDL) -e $(GHDLFLAGS) -o $@  $@

SampleBufferSDRAMTb: SampleBufferSDRAMTb.o
	$(GHDL) -e $(GHDLFLAGS) -o $@  $@

# Run target
run: CommandWrapperTb
	$(GHDL) -r $^ $(GHDLRUNFLAGS)

CommandMuxPkg.o: CommandMuxPkg.vhd
ByteStuffer.o: ByteStuffer.vhd
SFifo.o: SFifo.vhd
ByteDeStuffer.o: ByteDeStuffer.vhd
CommandMux.o: CommandMux.vhd ILAWrapperPkg.o
CommandVersion.o: CommandVersion.vhd CommandMuxPkg.o BasicPkg.o
SynchronizerBit.o: SynchronizerBit.vhd
BitBangIF.o: BitBangIF.vhd
CommandBitBang.o: CommandBitBang.vhd BitBangIF.o
SimPty.o: SimPty.vhd
MaxAdc.o: MaxAdc.vhd SampleBufferBRAM.o SampleBufferSDRAM.o SDRAMPkg.o
CommandWrapper.o: CommandWrapper.vhd SDRAMPkg.o CommandVersion.o
CommandWrapperTb.o: CommandWrapperTb.vhd CommandMuxPkg.o
CommandWrapperSim.o: CommandWrapperSim.vhd $(OBJS) SimPty.o SimPtyIO.o
SDRAMPkg.o: SDRAMPkg.vhd
SampleBufferBRAMTb.o: SampleBufferTbNotbound.o SampleBufferBRAM.o
SampleBufferSDRAMTb.o: SampleBufferTbNotbound.o SampleBufferSDRAM.o RamEmul.o
RamEmul.o: RamEmul.vhd

%.o: %.vhd
	$(GHDL) -a $(GHDLFLAGS) $<

SimPtyIO.o: SimPtyIO.cc
	g++ -Wall -c -O2 -o $@ $<

# Files dependences
CommandMuxPkg.o:  BasicPkg.o
ByteStuffer.o:
SFifo.o:
ByteDeStuffer.o:
CommandMux.o:    CommandMuxPkg.o
SynchronizerBit.o:
BitBangIF.o:     SynchronizerBit.o BasicPkg.o
CommandBitBang.o:     CommandMuxPkg.o BitBangIF.o
MaxAdc.o:    CommandMuxPkg.o ILAWrapper.o AcqCtlPkg.o BasicPkg.o CicFilter.o PipelinedRShifter.o MulShifter.o
CommandWrapper.o:    CommandMuxPkg.o ByteDeStuffer.o ByteStuffer.o CommandMux.o CommandBitBang.o MaxAdc.o CommandAcqParm.o CommandSpi.o CommandReg.o SimpleBusPipeStage.o
CommandWrapperTb.o:      CommandMuxPkg.o ByteStuffer.o SFifo.o ByteDeStuffer.o CommandWrapper.o
CommandAcqParm.o: AcqCtlPkg.o CommandMuxPkg.o
PipelinedRShifterTb.o: PipelinedRShifter.o
CommandSpi.o: SpiBitShifter.o CommandMuxPkg.o
SpiFlashSim.o: SpiReg.o
CommandWrapperSim.o: SpiReg.o SpiChecker.o
CommandReg.o: CommandMuxPkg.o BasicPkg.o SimpleBusAsync.o

SimpleBusPipeStage.o: CommandMuxPkg.o BasicPkg.o

SimpleBusPipeStageTb.o: SimpleBusPipeStage.o CommandMuxPkg.o BasicPkg.o

SimpleBusAsync.o: SynchronizerBit.o CommandMuxPkg.o

SpiShadowRegTb.o: SpiShadowReg.o SpiReg.o SpiChecker.o

SampleBufferBRAM.o: SynchronizerBit.o SDRAMPkg.o BasicPkg.o

SampleBufferSDRAM.o: SynchronizerBit.o SDRAMPkg.o GenericFifoAsync.o

CommandReg.o: CommandMuxPkg.o

SampleBufferTbNotbound.o: SDRAMPkg.o 

MulShifter.o PipelinedRShifter.o SpiBitShifter.o CommandBitBang.o SpiShadowReg.o: BasicPkg.o

CicFilterTb.o: CicFilter.o

SpiRegTb.o: SpiReg.o

GITVERSION:=$(shell git rev-parse --short=8 HEAD)
BRDVERSION:=01

.PHONY: .FORCE all clean test

clean:
	$(RM) $(OBJS) SimPty.o SimPtyIO.o CommandWrapperSim.o
	$(RM) dump.ghw work-obj*.cf e~*.o
	$(RM) $(TESTS:%=%.o) $(TESTS)
